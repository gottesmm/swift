// RUN: %target-sil-opt -sil-move-only-canonicalization %s | %FileCheck %s

sil_stage raw

struct E : ~Copyable {}

sil @use_e_indirect : $@convention(thin) (@in_guaranteed E) -> ()

// CHECK-LABEL: sil [ossa] @simple_indirect_guaranteed_spill : $@convention(thin) (@guaranteed E) -> () {
// CHECK: bb0([[ARG:%.*]] : @guaranteed $E):
// CHECK:   [[STACK:%.*]] = alloc_stack $E
// CHECK:   [[BORROW:%.*]] = store_borrow [[ARG]] to [[STACK]]
// CHECK:   apply {{%.*}}([[BORROW]])
// CHECK:   end_borrow [[BORROW]]
// CHECK:   dealloc_stack [[STACK]]
// CHECK: } // end sil function 'simple_indirect_guaranteed_spill'
sil [ossa] @simple_indirect_guaranteed_spill : $@convention(thin) (@guaranteed E) -> () {
bb0(%0 : @guaranteed $E):
  %1 = alloc_stack $E
  %2 = copy_value %0 : $E
  store %2 to [init] %1 : $*E
  %f = function_ref @use_e_indirect : $@convention(thin) (@in_guaranteed E) -> ()
  apply %f(%1) : $@convention(thin) (@in_guaranteed E) -> ()
  destroy_addr %1 : $*E
  dealloc_stack %1 : $*E
  %9999 = tuple()
  return %9999 : $()
}
